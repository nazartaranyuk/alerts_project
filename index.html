<!doctype html>
<html lang="uk">
<head>
    <meta charset="utf-8"/>
    <title>Live Location</title>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <style>
        html,body,#map{height:100%;margin:0}
        .panel{position:absolute;z-index:1000;top:10px;left:10px;background:#fff;padding:8px 10px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.15);font-family:system-ui,Segoe UI,Arial}
        .row{display:flex;gap:8px;align-items:center}
        input,button{padding:6px 10px;border-radius:6px;border:1px solid #ddd}
        button{cursor:pointer;background:#f6f6f6}
        #status{font-size:12px;color:#666;margin-left:6px}
    </style>
</head>
<body>
<div class="panel">
    <div class="row" style="margin-bottom:6px">
        <label for="user">UserID:</label>
        <input id="user" value="nazar">
        <button id="connect">Connect</button>
        <button id="disconnect">Disconnect</button>
        <span id="status">disconnected</span>
    </div>
    <div class="row">
        <button id="start">Start share</button>
        <button id="stop">Stop share</button>
    </div>
</div>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    let ws = null;
    let watcher = null;
    let marker = null;

    // ❗️ Узгодь це з адресою свого Go-сервера
    const WS_HOST = "127.0.0.1:8080"; // або "localhost:8080"

    const map = L.map('map').setView([49.588, 34.551], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);

    function setStatus(s){ document.getElementById('status').textContent = s; }

    function connect() {
        const userId = document.getElementById('user').value.trim() || 'anonymous';
        // ✅ Саме WebSocket, не fetch:
        ws = new WebSocket(`ws://${WS_HOST}/ws?user_id=${encodeURIComponent(userId)}`);

        ws.onopen = () => setStatus('connected');
        ws.onclose = () => { setStatus('disconnected'); ws = null; };
        ws.onerror = () => setStatus('error');
        ws.onmessage = (ev) => {
            try {
                const msg = JSON.parse(ev.data);
                // очікуємо Payload з сервера: {user_id, lat, lon, accuracy, ts}
                if (typeof msg.lat !== 'number' || typeof msg.lon !== 'number') return;
                if (!marker) {
                    marker = L.marker([msg.lat, msg.lon]).addTo(map);
                    map.setView([msg.lat, msg.lon], 15);
                } else {
                    marker.setLatLng([msg.lat, msg.lon]);
                }
            } catch (_) {}
        };
    }

    function disconnect() {
        stopShare();
        if (ws) { ws.close(); ws = null; }
    }

    function startShare() {
        if (!ws || ws.readyState !== WebSocket.OPEN) {
            alert('WS не підключено'); return;
        }
        if (!navigator.geolocation) { alert('Geolocation не підтримується'); return; }
        if (watcher !== null) return;

        const userId = document.getElementById('user').value.trim() || 'anonymous';

        watcher = navigator.geolocation.watchPosition(pos => {
            const payload = {
                type: "loc",
                user_id: userId,
                lat: pos.coords.latitude,
                lon: pos.coords.longitude,
                accuracy: pos.coords.accuracy,
                ts: new Date().toISOString()
            };
            // ✅ Надсилаємо через WS, не через fetch:
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify(payload));
            }
        }, err => {
            console.error('geolocation error', err);
        }, {enableHighAccuracy:true, maximumAge:5000, timeout:10000});
    }

    function stopShare() {
        if (watcher !== null) {
            navigator.geolocation.clearWatch(watcher);
            watcher = null;
        }
    }

    document.getElementById('connect').onclick = connect;
    document.getElementById('disconnect').onclick = disconnect;
    document.getElementById('start').onclick = startShare;
    document.getElementById('stop').onclick = stopShare;

    // опційно: автоконект при завантаженні
    // connect();
</script>
</body>
</html>
